<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸš” Erzurum Emniyet | Master Diamond v34</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <style>
        :root { 
            --primary: #1e3a8a; --accent: #ffd700; --success: #16a34a; 
            --danger: #dc2626; --warning: #f97316; --info: #2563eb; --sidebar-bg: #ffffff;
            --card-active: #ecfdf5; --card-passive: #fef2f2;
        }
        body { font-family: 'Segoe UI', Tahoma, sans-serif; margin: 0; background: #f0f2f5; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        
        header { background: linear-gradient(135deg, #0a192f 0%, #1e3a8a 100%); color: white; padding: 12px 25px; display: flex; justify-content: space-between; align-items: center; z-index: 1000; border-bottom: 4px solid var(--accent); box-shadow: 0 4px 15px rgba(0,0,0,0.3); }
        .toolbar { padding: 10px 20px; background: white; border-bottom: 2px solid #e2e8f0; display: flex; gap: 8px; align-items: center; z-index: 999; flex-wrap: wrap; }
        
        .main-layout { display: grid; grid-template-columns: 1fr 520px; flex: 1; overflow: hidden; }
        #map { width: 100%; height: 100%; cursor: crosshair; position: relative; }
        .sidebar { background: var(--sidebar-bg); border-left: 1px solid #e2e8f0; overflow-y: auto; padding: 20px; }

        .dashboard { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-bottom: 20px; background: #f8fafc; padding: 15px; border-radius: 12px; border: 1px solid #cbd5e1; }
        .dash-card { text-align: center; padding: 8px; border-radius: 10px; background: white; border-bottom: 4px solid #94a3b8; }
        .dash-card b { display: block; font-size: 1.2rem; color: var(--primary); }

        /* GÃ¶rev KartÄ± - image_7a4fdc.png stili */
        .task-card { background: white; border-radius: 15px; padding: 18px; border-left: 15px solid #94a3b8; box-shadow: 0 6px 15px rgba(0,0,0,0.1); margin-bottom: 20px; position: relative; border-right: 1px solid #ddd; border-top: 1px solid #ddd; transition: 0.3s; }
        .active-card { border-left-color: var(--success) !important; background: var(--card-active) !important; }
        .passive-card { border-left-color: var(--danger) !important; background: var(--card-passive) !important; }

        /* Butonlar - Gri Kesinlikle Yok */
        .btn { padding: 10px 14px; border: none; border-radius: 10px; cursor: pointer; font-weight: 800; color: white; display: flex; align-items: center; gap: 6px; font-size: 0.85rem; transition: 0.2s; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .btn-excel { background: #107c41; }
        .btn-word { background: #2b5797; }
        .btn-pdf { background: #e11d48; }
        .btn-print { background: #6366f1; }
        .btn-wa { background: #25d366; }
        .btn-save { background: #1e3a8a; border: 2px solid var(--accent); width: 100%; justify-content: center; font-size: 1rem; padding: 15px; margin-top: 10px; }
        .btn-danger { background: var(--danger) !important; } /* Silme butonlarÄ± kÄ±pkÄ±rmÄ±zÄ± */
        .btn-undo { background: var(--warning) !important; } /* Geri al turuncu */

        #routeHelper { display: none; position: absolute; top: 20px; left: 50%; transform: translateX(-50%); background: rgba(10, 25, 47, 0.95); padding: 15px 35px; border-radius: 50px; z-index: 5000; align-items: center; gap: 15px; color: white; border: 2px solid var(--accent); box-shadow: 0 8px 30px rgba(0,0,0,0.5); }

        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.85); z-index: 6000; justify-content: center; align-items: center; }
        .modal-content { background: white; padding: 30px; border-radius: 25px; width: 500px; max-height: 90vh; overflow-y: auto; }
        input, select, textarea { width: 100%; padding: 12px; margin-bottom: 12px; border: 2px solid #cbd5e1; border-radius: 10px; box-sizing: border-box; font-size: 0.95rem; }
        label { font-weight: 800; font-size: 0.85rem; color: var(--primary); display: block; margin-bottom: 5px; }

        .police-marker-icon { display: flex !important; justify-content: center !important; align-items: center !important; filter: drop-shadow(0 4px 8px rgba(0,0,0,0.5)) !important; }

        @media print {
            @page { size: A4; margin: 0.5cm; }
            header, .toolbar, #map, #routeHelper, .btn-group-card, .share-check { display: none !important; }
            body { background: white; overflow: visible; height: auto; }
            .main-layout { display: block; width: 100%; }
            .sidebar { border: none; padding: 0; width: 100%; overflow: visible; }
            .task-card { border: 2px solid #000 !important; border-left: 20px solid #000 !important; page-break-inside: avoid; margin-bottom: 15px; width: 100% !important; background: white !important; }
        }
    </style>
</head>
<body>

<header>
    <h1 style="margin:0;"><i class="fas fa-shield-halved"></i> ERZURUM EMNÄ°YET MÃœDÃœRLÃœÄÃœ | MASTER DIAMOND</h1>
    <div id="liveClock" style="font-weight:900; color:var(--accent);">00:00:00</div>
</header>

<div class="toolbar" id="mainToolbar">
    <input type="text" id="searchInput" placeholder="ğŸ” BÃ¶lge ara..." style="flex:1; padding:12px; border:2px solid #cbd5e1; border-radius:12px;">
    <button class="btn btn-excel" onclick="exportProfessionalExcel()"><i class="fas fa-file-excel"></i> EXCEL</button>
    <button class="btn btn-word" onclick="exportWord()"><i class="fas fa-file-word"></i> WORD</button>
    <button class="btn btn-pdf" onclick="exportPDF()"><i class="fas fa-file-pdf"></i> PDF</button>
    <button class="btn btn-print" onclick="window.print()"><i class="fas fa-print"></i> YAZDIR</button>
    <button class="btn btn-wa" id="bulkShare"><i class="fab fa-whatsapp"></i> PAYLAÅ</button>
    <button class="btn btn-danger" onclick="clearAllData()"><i class="fas fa-eraser"></i> SIFIRLA</button>
</div>

<div class="main-layout">
    <div id="map">
        <div id="routeHelper">
            <span style="font-weight:900; font-size:1.2rem;">ğŸ“ <span id="liveDist" style="color:var(--accent)">0 m</span></span>
            <input type="color" id="routeColor" value="#ff0000" style="width:35px; height:35px; border:none; border-radius:50%; cursor:pointer;">
            <button class="btn btn-undo" onclick="undoStep()">GERÄ° AL</button>
            <button class="btn" style="background:#16a34a" id="finishRouteBtn" onclick="finishRoute()">BÄ°TÄ°R (KAYDET)</button>
        </div>
    </div>
    
    <div class="sidebar" id="reportArea">
        <div class="dashboard">
            <div class="dash-card"><b><span id="stat_total">0</span></b><small>Toplam</small></div>
            <div class="dash-card"><b><span id="stat_active" style="color:var(--success)">0</span></b><small>Aktif</small></div>
            <div class="dash-card"><b><span id="stat_yunus">0</span></b><small>Yunus</small></div>
            <div class="dash-card"><b><span id="stat_trafik">0</span></b><small>Trafik</small></div>
        </div>
        <div id="taskList"></div>
    </div>
</div>

<div id="taskModal" class="modal">
    <div class="modal-content">
        <h2 id="modalTitle" style="margin-top:0; border-bottom: 3px solid #1e3a8a; padding-bottom:10px; color:#1e3a8a;">ğŸ“‹ GÃ¶rev KayÄ±t Formu</h2>
        <div id="addrDisplay" style="background:#f8fafc; padding:15px; border-radius:12px; font-size:0.85rem; margin-bottom:15px; border-left:6px solid #1e3a8a; font-weight:900;">ğŸ“ Konum belirleniyor...</div>
        
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:12px;">
            <div><label>Birim</label><select id="t_type"><option value="Devriye">ğŸš” Devriye Ekipler</option><option value="Trafik">ğŸš¥ Trafik Birimi</option><option value="Yunus">ğŸï¸ Yunus Timleri</option><option value="Siber">ğŸ’» Siber SuÃ§lar</option><option value="Ã–zel">ğŸ¹ Ã–zel Harekat</option><option value="Ã‡evik">ğŸ›¡ï¸ Ã‡evik Kuvvet</option></select></div>
            <div><label>GÃ¶rev TÃ¼rÃ¼</label><select id="t_duty"><option value="Åok Uygulama">âš¡ Åok Uygulama</option><option value="Rutin Devriye">ğŸ”„ Rutin Devriye</option><option value="Huzur UygulamasÄ±">ğŸ‘® Huzur</option><option value="Kapama">ğŸ›‘ Kapama</option><option value="Yaya Devriye">ğŸš¶ Yaya</option></select></div>
        </div>

        <label>Ekip No (Kodu)</label>
        <input type="text" id="t_team" placeholder="Ã–rn: 4555">

        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:12px;">
            <div><label>Personel 1</label><input type="text" id="t_p1" placeholder="RÃ¼tbe / Ä°sim"></div>
            <div><label>Personel 2</label><input type="text" id="t_p2" placeholder="RÃ¼tbe / Ä°sim"></div>
        </div>

        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:12px;">
            <div><label>BaÅŸlangÄ±Ã§</label><input type="time" id="t_start"></div>
            <div><label>BitiÅŸ</label><input type="time" id="t_end"></div>
        </div>

        <div style="display:flex; flex-direction:column; gap:10px; margin-top:10px;">
            <button class="btn btn-save" id="saveBtn">ğŸ’¾ GÃ–REVÄ° KAYDET</button>
            <button class="btn" style="background:#1e3a8a; border: 2px solid var(--accent); width: 100%; justify-content:center; padding:15px; font-size:1rem;" onclick="closeModals()">Ä°PTAL ET</button>
        </div>
    </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    let tasks = JSON.parse(localStorage.getItem('erzurum_diamond_v34')) || [];
    let map, markers = [], routeLines = [], pendingCoords = null, currentRoute = [], undoStack = [], routeTaskID = null;
    let editingId = null, pendingAddr = "";

    const typeIcons = { "Devriye": "ğŸš”", "Trafik": "ğŸš¥", "Yunus": "ğŸï¸", "Siber": "ğŸ’»", "Ã–zel": "ğŸ¹", "Ã‡evik": "ğŸ›¡ï¸" };

    function init() {
        map = L.map('map', { zoomControl: false }).setView([39.9043, 41.2717], 14);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

        L.DomEvent.disableClickPropagation(document.getElementById('routeHelper'));
        L.DomEvent.disableClickPropagation(document.getElementById('mainToolbar'));

        map.on('click', async (e) => {
            if (routeTaskID !== null) {
                undoStack.push([...currentRoute]); currentRoute.push([e.latlng.lat, e.latlng.lng]);
                drawTempRoute(); return;
            }
            editingId = null; pendingCoords = e.latlng;
            document.getElementById('modalTitle').innerText = "ğŸ“‹ Yeni GÃ¶rev GiriÅŸi";
            document.getElementById('taskModal').style.display = 'flex';
            await fetchAddress(e.latlng.lat, e.latlng.lng);
        });

        document.getElementById('saveBtn').onclick = saveTask;
        document.getElementById('bulkShare').onclick = bulkShare;
        setInterval(() => { document.getElementById('liveClock').innerText = new Date().toLocaleTimeString('tr-TR'); }, 1000);
        render();
    }

    async function fetchAddress(lat, lng) {
        try {
            const res = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&accept-language=tr`);
            const data = await res.json();
            pendingAddr = data.display_name.split(',').slice(0, 3).join(',');
            document.getElementById('addrDisplay').innerText = `ğŸ“ ${pendingAddr}`;
        } catch { pendingAddr = "Erzurum"; }
    }

    function saveTask() {
        const team = document.getElementById('t_team').value;
        if(!team) return alert("Hata: Ekip kodu girilmelidir!");
        const data = { team, p1: document.getElementById('t_p1').value, p2: document.getElementById('t_p2').value, type: document.getElementById('t_type').value, duty: document.getElementById('t_duty').value, start: document.getElementById('t_start').value, end: document.getElementById('t_end').value };
        if(editingId) { const idx = tasks.findIndex(t => t.id === editingId); tasks[idx] = { ...tasks[idx], ...data }; }
        else { tasks.push({ id: Date.now(), ...data, addr: pendingAddr, lat: pendingCoords.lat, lng: pendingCoords.lng, route: [], dist: "", routeColor: document.getElementById('routeColor').value }); }
        saveData(); closeModals();
    }

    function render() {
        markers.forEach(m => map.removeLayer(m)); markers = [];
        routeLines.forEach(l => map.removeLayer(l)); routeLines = [];
        const list = document.getElementById('taskList'); list.innerHTML = '';
        const now = new Date().getHours() * 60 + new Date().getMinutes();
        let s = { t: tasks.length, a: 0, y:0, tr:0 };

        tasks.forEach(t => {
            const [sh, sm] = (t.start || "00:00").split(':').map(Number);
            const [eh, em] = (t.end || "00:00").split(':').map(Number);
            const isActive = now >= (sh*60+sm) && now <= (eh*60+em);
            if(isActive) s.a++; if(t.type === "Yunus") s.y++; if(t.type === "Trafik") s.tr++;

            const m = L.marker([t.lat, t.lng], { icon: L.divIcon({ html: typeIcons[t.type], className:'police-marker-icon', iconSize:[50,50], iconAnchor:[25,25] }), draggable: true }).addTo(map);
            m.getElement().style.fontSize = "38px";
            m.on('dragend', async (e) => { const pos = e.target.getLatLng(); t.lat = pos.lat; t.lng = pos.lng; await fetchAddress(pos.lat, pos.lng); t.addr = pendingAddr; saveData(); });
            if(t.route && t.route.length > 1) { routeLines.push(L.polyline(t.route, {color: t.routeColor || '#ff0000', weight: 6, opacity: 0.9}).addTo(map)); }

            const popup = `<div style="width:230px; border-radius:12px; overflow:hidden; font-family:sans-serif;">
                <div style="background:#0a192f; color:white; padding:15px; font-weight:bold; font-size:1.1rem; border-bottom:3px solid var(--accent);">${typeIcons[t.type]} ${t.team}</div>
                <div style="padding:15px; background:white;"><b>P1:</b> ${t.p1 || '-'}<br><b>P2:</b> ${t.p2 || '-'}<br><b>GÃ¶rev:</b> ${t.duty}<br>
                ${t.dist ? `<b>Mesafe:</b> <span style="color:var(--success)">${t.dist}</span><br>` : ''}<hr>
                <div style="display:flex; flex-direction:column; gap:5px;"><button class="btn btn-save" style="padding:6px; font-size:0.75rem;" onclick="openEdit(${t.id})">DÃœZENLE</button>
                <button class="btn" style="background:#16a34a; padding:6px; font-size:0.75rem; justify-content:center;" onclick="startDraw(${t.id})">GÃœZERGAH Ã‡Ä°Z</button>
                <button class="btn btn-danger" style="padding:6px; font-size:0.75rem; justify-content:center;" onclick="deleteTask(${t.id})">SÄ°L</button></div></div></div>`;
            m.bindPopup(popup); markers.push(m);

            const card = document.createElement('div');
            card.className = `task-card ${isActive ? 'active-card' : 'passive-card'}`;
            card.innerHTML = `
                <div style="position:absolute; right:15px; top:15px;" class="share-check"><input type="checkbox" class="task-select" data-id="${t.id}" style="width:25px; height:25px;"></div>
                <div class="card-header"><span style="font-size:1.2rem; font-weight:900;">${isActive ? 'ğŸŸ¢' : 'ğŸ”´'} ${t.team} | ${t.start}</span></div>
                <div style="font-size:0.95rem; margin:10px 0; color:#334155; font-weight:900;">ğŸ“ ${t.addr}</div>
                <div style="font-size:0.85rem; background:white; padding:10px; border-radius:10px; border:1px solid #e2e8f0;">
                    ğŸ‘® <b>P1:</b> ${t.p1 || '-'} <br> ğŸ‘® <b>P2:</b> ${t.p2 || '-'} <br> ğŸ“‹ <b>GÃ¶rev:</b> ${t.duty} <br>
                    ${t.dist ? `ğŸ“ <b>Mesafe:</b> <span style="color:var(--success)">${t.dist}</span>` : ''}
                </div>
                <div class="btn-group-card" style="display:flex; gap:8px; margin-top:15px;">
                <button class="btn btn-print" onclick="map.flyTo([${t.lat},${t.lng}], 17)"><i class="fas fa-crosshairs"></i></button>
                <button class="btn btn-save" style="padding:8px" onclick="openEdit(${t.id})"><i class="fas fa-edit"></i></button>
                <button class="btn" style="background:#16a34a; padding:8px" onclick="startDraw(${t.id})"><i class="fas fa-route"></i></button>
                <button class="btn btn-danger" style="padding:8px" onclick="deleteTask(${t.id})"><i class="fas fa-trash"></i></button></div>`;
            list.appendChild(card);
        });
        document.getElementById('stat_total').innerText = s.t; document.getElementById('stat_active').innerText = s.a;
        document.getElementById('stat_yunus').innerText = s.y; document.getElementById('stat_trafik').innerText = s.tr;
    }

    window.exportProfessionalExcel = () => {
        const rows = [["T.C. ERZURUM EMNÄ°YET MÃœDÃœRLÃœÄÃœ GÃ–REV Ã‡Ä°ZELGESÄ°"],["Rapor Tarihi: " + new Date().toLocaleString('tr-TR')],[],["SIRA", "EKÄ°P NO", "BÄ°RÄ°M", "GÃ–REV TÃœRÃœ", "PERSONEL 1", "PERSONEL 2", "SAAT", "ADRES", "MESAFE"]];
        tasks.forEach((t, i) => { rows.push([i+1, t.team, t.type, t.duty, t.p1, t.p2, `${t.start}-${t.end}`, t.addr, t.dist || "0"]); });
        const ws = XLSX.utils.aoa_to_sheet(rows);
        ws['!cols'] = [{wch:6}, {wch:12}, {wch:18}, {wch:22}, {wch:25}, {wch:25}, {wch:18}, {wch:45}, {wch:15}];
        const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "Rapor");
        XLSX.writeFile(wb, "Erzurum_Emniyet_Master_Diamond.xlsx");
    };

    window.exportPDF = () => {
        const element = document.getElementById('reportArea');
        const opt = { margin: 0.5, filename: 'Erzurum_Emniyet_Gorev_Raporu.pdf', image: { type: 'jpeg', quality: 1 }, html2canvas: { scale: 3, useCORS: true }, jsPDF: { unit: 'cm', format: 'a4', orientation: 'portrait' } };
        html2pdf().set(opt).from(element).save();
    };

    window.exportWord = () => {
        let content = "ERZURUM EMNÄ°YET GÃ–REV LÄ°STESÄ°\n\n";
        tasks.forEach(t => { content += `[ EKÄ°P NO: ${t.team} ]--------------------------------\nBÄ°RÄ°M: ${t.type} | GÃ–REV: ${t.duty}\nP1: ${t.p1} | P2: ${t.p2}\nSAAT: ${t.start} - ${t.end}\nADRES: ${t.addr}\n\n`; });
        const blob = new Blob(['\ufeff' + content], { type: 'application/msword' });
        const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'Gorev_Raporu.doc'; a.click();
    };

    function bulkShare() {
        const selIds = Array.from(document.querySelectorAll('.task-select:checked')).map(cb => parseInt(cb.dataset.id));
        const data = selIds.length > 0 ? tasks.filter(t => selIds.includes(t.id)) : tasks;
        let msg = `ğŸš” *ERZURUM EMNÄ°YET GÃ–REV LÄ°STESÄ°*\n`;
        data.forEach((t, i) => { msg += `\n${i+1}. *${t.team}* (${t.duty})\nğŸ‘® ${t.p1} - ${t.p2}\nâ° ${t.start}-${t.end}\nğŸ“ ${t.addr}\nğŸ—ºï¸ https://www.google.com/maps?q=${t.lat},${t.lng}\n`; });
        window.open(`https://wa.me/?text=${encodeURIComponent(msg)}`);
    }

    window.startDraw = (id) => { routeTaskID = id; currentRoute = tasks.find(x => x.id === id).route || []; document.getElementById('routeHelper').style.display = 'flex'; map.closePopup(); };

    function finishRoute() {
        const t = tasks.find(x => x.id === routeTaskID);
        if(t) { t.route = currentRoute; t.dist = document.getElementById('liveDist').innerText; t.routeColor = document.getElementById('routeColor').value; }
        routeTaskID = null; document.getElementById('routeHelper').style.display = 'none'; saveData();
    }

    function drawTempRoute() {
        routeLines.forEach(l => map.removeLayer(l));
        routeLines = [];
        if (currentRoute.length < 2) { document.getElementById('liveDist').innerText = "0 m"; return; }
        const poly = L.polyline(currentRoute, {color: document.getElementById('routeColor').value, weight: 6, dashArray: '10, 10'}).addTo(map);
        routeLines.push(poly);
        let d = 0; for(let i=1; i<currentRoute.length; i++) d += L.latLng(currentRoute[i-1]).distanceTo(L.latLng(currentRoute[i]));
        document.getElementById('liveDist').innerText = d > 1000 ? (d/1000).toFixed(2) + " km" : Math.round(d) + " m";
    }

    window.undoStep = () => { if(undoStack.length > 0) { currentRoute = undoStack.pop(); drawTempRoute(); } };

    function clearAllData() { if(confirm("TÃ¼m kayÄ±tlar silinsin mi?")) { tasks = []; saveData(); } }
    function saveData() { localStorage.setItem('erzurum_diamond_v34', JSON.stringify(tasks)); render(); }
    function closeModals() { document.getElementById('taskModal').style.display = 'none'; editingId = null; }
    window.openEdit = (id) => { const t = tasks.find(x => x.id === id); editingId = id; document.getElementById('modalTitle').innerText = "ğŸ“ GÃ¶revi DÃ¼zenle"; document.getElementById('t_team').value = t.team; document.getElementById('t_p1').value = t.p1; document.getElementById('t_p2').value = t.p2; document.getElementById('t_type').value = t.type; document.getElementById('t_duty').value = t.duty; document.getElementById('t_start').value = t.start; document.getElementById('t_end').value = t.end; document.getElementById('taskModal').style.display = 'flex'; map.closePopup(); };
    window.deleteTask = (id) => { if(confirm("KayÄ±t silinsin mi?")) { tasks = tasks.filter(x => x.id !== id); saveData(); } };
    window.onload = init;
</script>
</body>
</html>
