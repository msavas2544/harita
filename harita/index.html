<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸš” Erzurum Emniyet | Master Diamond v15</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <style>
        :root { --primary: #0a192f; --accent: #ffd700; --success: #22c55e; --danger: #ef4444; --sidebar-bg: #ffffff; }
        body { font-family: 'Segoe UI', Tahoma, sans-serif; margin: 0; background: #f0f2f5; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        
        header { background: linear-gradient(to right, #0a192f, #1e3a8a); color: white; padding: 15px 25px; display: flex; justify-content: space-between; align-items: center; z-index: 1000; border-bottom: 3px solid var(--accent); }
        .toolbar { padding: 12px 20px; background: white; border-bottom: 1px solid #e2e8f0; display: flex; gap: 15px; align-items: center; z-index: 999; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        
        .main-layout { display: grid; grid-template-columns: 1fr 450px; flex: 1; overflow: hidden; }
        #map { width: 100%; height: 100%; cursor: crosshair; position: relative; }
        .sidebar { background: var(--sidebar-bg); border-left: 1px solid #e2e8f0; overflow-y: auto; padding: 25px; }

        /* GÃ¶rev KartÄ± TasarÄ±mÄ± */
        .task-card { background: white; border-radius: 15px; padding: 18px; border-left: 12px solid #94a3b8; box-shadow: 0 5px 15px rgba(0,0,0,0.08); margin-bottom: 20px; transition: 0.3s; position: relative; }
        .active-card { border-left-color: var(--success) !important; }
        .passive-card { border-left-color: var(--danger) !important; }
        .card-header { display: flex; justify-content: space-between; font-weight: 900; font-size: 1.2rem; }

        .btn { padding: 10px 18px; border: none; border-radius: 10px; cursor: pointer; font-weight: 700; color: white; display: flex; align-items: center; gap: 8px; transition: 0.2s; font-size: 0.85rem; }
        .btn-primary { background: #1e3a8a; }
        .btn-success { background: var(--success); }
        .btn-danger { background: var(--danger); }
        .btn-gold { background: var(--accent); color: #0a192f; }

        /* Ã‡izim Modu Ãœst Paneli - Click korumalÄ± */
        #routeHelper { 
            display: none; position: absolute; top: 30px; left: 50%; transform: translateX(-50%); 
            background: rgba(10, 25, 47, 0.95); padding: 15px 35px; border-radius: 50px; 
            box-shadow: 0 10px 40px rgba(0,0,0,0.6); z-index: 5000; align-items: center; gap: 20px; 
            color: white; border: 2px solid var(--accent); 
        }

        /* Modal TasarÄ±mÄ± (Merkezde) */
        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.85); z-index: 6000; justify-content: center; align-items: center; }
        .modal-content { background: white; padding: 35px; border-radius: 20px; width: 480px; box-shadow: 0 30px 60px rgba(0,0,0,0.5); }
        input, textarea { width: 100%; padding: 12px; margin-bottom: 12px; border: 2px solid #e2e8f0; border-radius: 10px; box-sizing: border-box; font-family: inherit; }

        .police-marker-icon { display: flex !important; justify-content: center !important; align-items: center !important; filter: drop-shadow(0 4px 8px rgba(0,0,0,0.6)) !important; }

        @media print {
            header, .toolbar, #map, #routeHelper, .btn-group, .btn-mini { display: none !important; }
            body { background: white; overflow: visible; }
            .main-layout { display: block; }
            .sidebar { width: 100%; border: none; }
            .task-card { border: 2px solid #000; margin-bottom: 30px; page-break-inside: avoid; }
        }
    </style>
</head>
<body>

<header>
    <h1 style="margin:0;"><i class="fas fa-tower-broadcast"></i> ERZURUM EMNÄ°YET MÃœDÃœRLÃœÄÃœ</h1>
    <div id="liveClock" style="font-weight:900; letter-spacing:2px; color:var(--accent); font-size: 1.2rem;">00:00:00</div>
</header>

<div class="toolbar" id="mainToolbar">
    <input type="text" id="searchInput" placeholder="ğŸ” Erzurum'da sokak/mahalle ara..." style="flex:1; padding:12px; border:2px solid #e2e8f0; border-radius:12px; outline:none;">
    
    <div style="display:flex; align-items:center; gap:10px; background:#f8fafc; padding:8px 15px; border-radius:10px; border:1px solid #e2e8f0;">
        <small>Simge:</small>
        <input type="range" id="iconSizeSlider" min="30" max="100" value="50" style="width: 80px; cursor: pointer;">
    </div>

    <button class="btn btn-primary" id="searchBtn">Bul</button>
    <button class="btn btn-gold" onclick="exportProfessionalExcel()"><i class="fas fa-file-excel"></i> Rapor</button>
    <button class="btn btn-primary" style="background:#475569" onclick="window.print()"><i class="fas fa-print"></i> YazdÄ±r</button>
    <button class="btn btn-success" id="bulkShare"><i class="fab fa-whatsapp"></i> PaylaÅŸ</button>
</div>

<div class="main-layout">
    <div id="map">
        <div id="routeHelper">
            <span style="font-size:1.1rem;">ğŸ“ <span id="liveDist" style="color:var(--accent)">0 m</span></span>
            <div style="display:flex; gap:10px;">
                <button class="btn btn-danger" style="padding:8px 15px" onclick="undoStep()">Geri Al</button>
                <button class="btn btn-success" style="padding:8px 15px" onclick="finishRoute()">Bitir</button>
            </div>
        </div>
    </div>
    <div class="sidebar">
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px; margin-bottom:30px;">
            <div style="background:#f8fafc; padding:20px; border-radius:15px; text-align:center; border:1px solid #e2e8f0;">
                <small>TOPLAM EKÄ°P</small><div id="totalCount" style="font-size:2rem; font-weight:900;">0</div>
            </div>
            <div style="background:#f0fdf4; padding:20px; border-radius:15px; text-align:center; border:1px solid #bbf7d0;">
                <small>AKTÄ°F GÃ–REV</small><div id="activeCount" style="font-size:2rem; font-weight:900; color:var(--success);">0</div>
            </div>
        </div>
        <div id="taskList"></div>
    </div>
</div>

<div id="taskModal" class="modal">
    <div class="modal-content">
        <h2 style="margin-top:0; color:var(--primary);"><i class="fas fa-file-signature"></i> GÃ¶rev KaydÄ±</h2>
        <div id="addrDisplay" style="background:#f8fafc; padding:15px; border-radius:12px; font-size:0.9rem; color:#475569; margin-bottom:20px; border-left:5px solid #1e3a8a;">ğŸ“ Konum alÄ±nÄ±yor...</div>
        <input type="text" id="t_team" placeholder="Ekip Kodu (Ã–rn: 25-10)">
        <input type="text" id="t_person" placeholder="Personel RÃ¼tbe / Ä°sim">
        <div style="display:flex; gap:15px;"><input type="time" id="t_start"> <input type="time" id="t_end"></div>
        <textarea id="t_desc" rows="4" placeholder="GÃ¶rev talimatÄ± ve notlar..."></textarea>
        <div style="display:flex; gap:10px;">
            <button class="btn btn-success" id="saveBtn" style="flex:2;">ğŸ’¾ KAYDET</button>
            <button class="btn btn-danger" onclick="closeModals()" style="flex:1;">Ä°PTAL</button>
        </div>
    </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script>
    let tasks = JSON.parse(localStorage.getItem('erzurum_diamond_v15')) || [];
    let map, markers = [], routeLines = [], pendingCoords = null, currentRoute = [], undoStack = [], routeTaskID = null;
    let ghostLine = null, currentIconSize = 50, pendingAddr = "";

    function init() {
        map = L.map('map', { zoomControl: false }).setView([39.9043, 41.2717], 14);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

        // UI elemanlarÄ±na tÄ±klandÄ±ÄŸÄ±nda harita tÄ±klamasÄ±nÄ± engelle
        L.DomEvent.disableClickPropagation(document.getElementById('routeHelper'));
        L.DomEvent.disableClickPropagation(document.getElementById('mainToolbar'));

        map.on('click', async (e) => {
            if(routeTaskID) {
                undoStack.push([...currentRoute]);
                currentRoute.push([e.latlng.lat, e.latlng.lng]);
                drawTempRoute(); return;
            }
            pendingCoords = e.latlng;
            document.getElementById('taskModal').style.display = 'flex';
            await fetchAddress(e.latlng.lat, e.latlng.lng);
        });

        map.on('mousemove', (e) => {
            if(routeTaskID && currentRoute.length > 0) {
                if(ghostLine) map.removeLayer(ghostLine);
                ghostLine = L.polyline([currentRoute[currentRoute.length - 1], [e.latlng.lat, e.latlng.lng]], {color: '#3b82f6', weight: 2, dashArray: '5, 5', opacity: 0.6}).addTo(map);
            }
        });

        document.getElementById('iconSizeSlider').oninput = (e) => { currentIconSize = e.target.value; render(); };
        setInterval(() => { document.getElementById('liveClock').innerText = new Date().toLocaleTimeString('tr-TR'); }, 1000);
        render();
    }

    async function fetchAddress(lat, lng) {
        try {
            const res = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&accept-language=tr`);
            const data = await res.json();
            pendingAddr = data.display_name.split(',').slice(0, 3).join(',');
            document.getElementById('addrDisplay').innerText = `ğŸ“ ${pendingAddr}`;
            return pendingAddr;
        } catch { return "Erzurum"; }
    }

    function drawTempRoute() {
        routeLines.forEach(l => map.removeLayer(l));
        const poly = L.polyline(currentRoute, {color: '#3b82f6', weight: 6, dashArray: '10, 10'}).addTo(map);
        routeLines.push(poly);
        let d = 0;
        for(let i=1; i<currentRoute.length; i++) d += L.latLng(currentRoute[i-1]).distanceTo(L.latLng(currentRoute[i]));
        document.getElementById('liveDist').innerText = d > 1000 ? (d/1000).toFixed(2) + " km" : Math.round(d) + " m";
    }

    window.undoStep = () => { if(undoStack.length > 0) { currentRoute = undoStack.pop(); drawTempRoute(); } };

    document.getElementById('saveBtn').onclick = () => {
        const team = document.getElementById('t_team').value;
        if(!team) return alert("Ekip kodu giriniz!");
        tasks.push({
            id: Date.now(), team, person: document.getElementById('t_person').value,
            start: document.getElementById('t_start').value, end: document.getElementById('t_end').value,
            desc: document.getElementById('t_desc').value, addr: pendingAddr,
            lat: pendingCoords.lat, lng: pendingCoords.lng, route: [], dist: ""
        });
        saveData(); closeModals();
    };

    function render() {
        markers.forEach(m => map.removeLayer(m)); markers = [];
        routeLines.forEach(l => map.removeLayer(l)); routeLines = [];
        const list = document.getElementById('taskList'); list.innerHTML = '';
        const nowMin = new Date().getHours() * 60 + new Date().getMinutes();
        let activeCount = 0;

        tasks.forEach(t => {
            const [sh, sm] = (t.start || "00:00").split(':').map(Number);
            const [eh, em] = (t.end || "00:00").split(':').map(Number);
            const isActive = nowMin >= (sh*60+sm) && nowMin <= (eh*60+em);
            if(isActive) activeCount++;

            const dynamicIcon = L.divIcon({ 
                html: `ğŸš”`, className: 'police-marker-icon', iconSize: [currentIconSize, currentIconSize], 
                iconAnchor: [currentIconSize/2, currentIconSize/2], popupAnchor: [0, -currentIconSize/2] 
            });

            const m = L.marker([t.lat, t.lng], {icon: dynamicIcon, draggable: true}).addTo(map);
            m.getElement().style.fontSize = `${currentIconSize}px`;
            if(t.route && t.route.length > 1) routeLines.push(L.polyline(t.route, {color: isActive ? '#22c55e' : '#64748b', weight: 5}).addTo(map));

            m.on('dragend', async (e) => {
                const pos = e.target.getLatLng();
                t.lat = pos.lat; t.lng = pos.lng;
                t.addr = await fetchAddress(pos.lat, pos.lng);
                saveData();
            });

            const popupHtml = `
                <div class="task-card ${isActive ? 'active-card' : 'passive-card'}" style="margin:0; border-radius:0; border-left-width:15px;">
                    <div class="card-header"><span style="color:${isActive ? '#22c55e' : '#ef4444'}">${isActive ? 'âœ…' : 'ğŸ”´'} ${t.team}</span><small>${t.start}-${t.end}</small></div>
                    <div style="font-size:0.9rem; margin:10px 0;"><b>ğŸ‘® ${t.person}</b></div>
                    <div style="font-size:0.8rem; background:#f1f5f9; padding:10px; border-radius:8px;">${t.desc || '---'}</div>
                    ${t.dist ? `<div style="font-size:0.8rem; color:#1e3a8a; font-weight:bold; margin-top:8px;">ğŸ“ GÃ¼zergah: ${t.dist}</div>` : ''}
                    <div style="display:flex; gap:10px; margin-top:15px;">
                        <button class="btn btn-primary" style="flex:1; padding:8px;" onclick="startDraw(${t.id})">GÃ¼zergah</button>
                        <button class="btn btn-success" style="flex:1; padding:8px;" onclick="shareWA(${t.id})">ğŸ“¤ PaylaÅŸ</button>
                    </div>
                </div>`;
            m.bindPopup(popupHtml); markers.push(m);

            const card = document.createElement('div');
            card.className = `task-card ${isActive ? 'active-card' : 'passive-card'}`;
            card.innerHTML = `
                <div class="card-header"><span style="color:${isActive ? '#22c55e' : '#ef4444'}">${isActive ? 'âœ…' : 'ğŸ”´'} ${t.team}</span><small>${t.start}</small></div>
                <div style="font-size:0.9rem; margin:5px 0; color:#475569;">ğŸ“ ${t.addr}</div>
                <div style="font-size:0.8rem; font-weight:bold; color:var(--primary);">ğŸ‘® ${t.person}</div>
                <div style="display:flex; gap:10px; margin-top:15px;">
                    <button class="btn btn-primary" style="padding:8px 15px;" onclick="map.flyTo([${t.lat},${t.lng}], 17)"><i class="fas fa-crosshairs"></i></button>
                    <button class="btn btn-success" style="flex:1; padding:8px;" onclick="shareWA(${t.id})">ğŸ“¤ At</button>
                    <button class="btn btn-danger" style="padding:8px 15px;" onclick="deleteTask(${t.id})"><i class="fas fa-trash"></i></button>
                </div>`;
            list.appendChild(card);
        });
        document.getElementById('totalCount').innerText = tasks.length;
        document.getElementById('activeCount').innerText = activeCount;
    }

    window.exportProfessionalExcel = () => {
        const header = [["T.C. ERZURUM EMNÄ°YET MÃœDÃœRLÃœÄÃœ GÃ–REV RAPORU"], ["Rapor Tarihi: " + new Date().toLocaleString('tr-TR')], []];
        const tableHeaders = ["EKÄ°P KODU", "PERSONEL BÄ°LGÄ°SÄ°", "GÃ–REV SAATÄ°", "ADRES BÄ°LGÄ°SÄ°", "GÃœZERGAH MESAFESÄ°"];
        const rows = tasks.map(t => [t.team, t.person, `${t.start}-${t.end}`, t.addr, t.dist || '---']);
        const ws = XLSX.utils.aoa_to_sheet([...header, tableHeaders, ...rows]);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Gorevler");
        XLSX.writeFile(wb, "Erzurum_Emniyet_Diamond_Raporu.xlsx");
    };

    window.startDraw = (id) => {
        const t = tasks.find(x => x.id === id);
        routeTaskID = id; currentRoute = t.route || [];
        document.getElementById('routeHelper').style.display = 'flex';
        map.closePopup();
    };

    window.finishRoute = () => {
        const t = tasks.find(x => x.id === routeTaskID);
        if(t) { t.route = currentRoute; t.dist = document.getElementById('liveDist').innerText; }
        if(ghostLine) map.removeLayer(ghostLine);
        setTimeout(() => { routeTaskID = null; }, 150); // Click engelleme sÃ¼resi
        document.getElementById('routeHelper').style.display = 'none'; saveData();
    };

    window.shareWA = (id) => {
        const t = tasks.find(x => x.id === id);
        const msg = `ğŸš” *GÃ–REV BÄ°LGÄ°SÄ°*\nğŸ‘® *Ekip:* ${t.team}\nğŸ‘¤ *Personel:* ${t.person}\nğŸ• *Saat:* ${t.start}-${t.end}\nğŸ“ *Adres:* ${t.addr}\nğŸ—ºï¸ *Navigasyon:* https://www.google.com/maps?q=${t.lat},${t.lng}`;
        window.open(`https://wa.me/?text=${encodeURIComponent(msg)}`);
    };

    document.getElementById('searchBtn').onclick = async () => {
        const q = document.getElementById('searchInput').value;
        const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(q + ', Erzurum')}&limit=1`);
        const data = await res.json();
        if(data[0]) map.flyTo([data[0].lat, data[0].lon], 16);
    };

    function saveData() { localStorage.setItem('erzurum_diamond_v15', JSON.stringify(tasks)); render(); }
    function closeModals() { document.getElementById('taskModal').style.display = 'none'; }
    window.deleteTask = (id) => { if(confirm("KayÄ±t silinsin mi?")) { tasks = tasks.filter(x => x.id !== id); saveData(); } };
    window.onload = init;
</script>
</body>
</html>